<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Judge è°ƒè¯•è¯¦æƒ…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 15px;
        }
        
        .back-link {
            display: inline-block;
            color: #667eea;
            text-decoration: none;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        .entry-info {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .entry-info h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .info-value {
            color: #333;
            font-size: 16px;
            word-break: break-all;
        }
        
        .image-preview {
            margin-top: 15px;
            max-width: 600px;
        }
        
        .image-preview img {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .judge-card {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .judge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .judge-name {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
        }
        
        .judge-model {
            font-size: 14px;
            color: #666;
            background: white;
            padding: 5px 15px;
            border-radius: 20px;
        }
        
        .toggle-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background 0.3s;
        }
        
        .toggle-button:hover {
            background: #5568d3;
        }
        
        .collapsible-content {
            margin-top: 15px;
            display: none;
        }
        
        .collapsible-content.active {
            display: block;
        }
        
        .context-box {
            background: #2d2d2d;
            color: #f8f8f2;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            overflow-x: auto;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .context-label {
            font-weight: bold;
            color: #50fa7b;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .response-box {
            background: #fff9e6;
            border-left: 4px solid #ffb700;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        
        .response-label {
            font-weight: bold;
            color: #ff8c00;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .score-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .json-output {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre;
        }
        
        .debate-message {
            background: #f0f7ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
        }
        
        .debate-speaker {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .debate-content {
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .debate-sequence {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 10px;
        }
        
        .no-data {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 16px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }
        
        .error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 20px;
            border-radius: 6px;
            color: #c62828;
            margin: 20px 0;
        }
        
        .copy-button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            float: right;
            margin-top: -5px;
        }
        
        .copy-button:hover {
            background: #45a049;
        }
        
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-button {
            background: #f0f0f0;
            color: #666;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            background: #667eea;
            color: white;
        }
        
        .tab-button:hover {
            background: #e0e0e0;
        }
        
        .tab-button.active:hover {
            background: #5568d3;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="back-link">â† è¿”å›ä¸»é¡µ</a>
            <h1>ğŸ” AI Judge è°ƒè¯•è¯¦æƒ…</h1>
        </div>
        
        <div id="loading" class="section">
            <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        
        <div id="error" style="display:none;"></div>
        
        <div id="content" style="display:none;">
            <!-- ä½œå“ä¿¡æ¯ -->
            <div class="entry-info">
                <h2>ğŸ“ ä½œå“ä¿¡æ¯</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">ä½œå“ ID</div>
                        <div class="info-value" id="entryId">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æ¯”èµ›ç±»å‹</div>
                        <div class="info-value" id="competitionType">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">åˆ›å»ºæ—¶é—´</div>
                        <div class="info-value" id="createdAt">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">è¡¥å……è¯´æ˜</div>
                        <div class="info-value" id="extraText">-</div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">å›¾ç‰‡ URL</div>
                    <div class="info-value" id="imageUrl">-</div>
                </div>
                <div class="image-preview" id="imagePreview"></div>
            </div>
            
            <!-- Tab åˆ‡æ¢æŒ‰é’® -->
            <div class="section">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('stage1')">é˜¶æ®µä¸€ï¼šç‹¬ç«‹è¯„åˆ†</button>
                    <button class="tab-button" onclick="switchTab('stage2')">é˜¶æ®µäºŒï¼šç¾¤èŠè®¨è®º</button>
                </div>
                
                <!-- é˜¶æ®µä¸€å†…å®¹ -->
                <div id="stage1Tab" class="tab-content active">
                    <h2>ğŸ“Š é˜¶æ®µä¸€ï¼šç‹¬ç«‹è¯„åˆ†è¯¦æƒ…</h2>
                    <p style="color: #666; margin-bottom: 20px;">å±•ç¤ºæ¯ä¸ª AI è¯„å§”æ”¶åˆ°çš„å®Œæ•´è¯·æ±‚ä¸Šä¸‹æ–‡å’Œå›å¤ç»“æœ</p>
                    <div id="stageOneContent"></div>
                </div>
                
                <!-- é˜¶æ®µäºŒå†…å®¹ -->
                <div id="stage2Tab" class="tab-content">
                    <h2>ğŸ’¬ é˜¶æ®µäºŒï¼šç¾¤èŠè®¨è®ºè¯¦æƒ…</h2>
                    <p style="color: #666; margin-bottom: 20px;">å±•ç¤ºè¯„å§”ä»¬åœ¨ç¾¤èŠä¸­çš„è®¨è®ºè¿‡ç¨‹</p>
                    <div id="stageTwoContent"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ä» URL è·å– entry_id
        const urlParams = new URLSearchParams(window.location.search);
        const entryId = urlParams.get('entry_id');
        
        if (!entryId) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').innerHTML = '<div class="error">é”™è¯¯ï¼šæœªæä¾›ä½œå“ ID</div>';
            document.getElementById('error').style.display = 'block';
        } else {
            loadDebugInfo(entryId);
        }
        
        async function loadDebugInfo(entryId) {
            try {
                const response = await fetch(`/api/debug/entry/${entryId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                renderDebugInfo(data);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
            } catch (error) {
                console.error('åŠ è½½è°ƒè¯•ä¿¡æ¯å¤±è´¥:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').innerHTML = `
                    <div class="error">
                        <strong>åŠ è½½å¤±è´¥:</strong> ${error.message}
                    </div>
                `;
                document.getElementById('error').style.display = 'block';
            }
        }
        
        function renderDebugInfo(data) {
            // æ¸²æŸ“ä½œå“ä¿¡æ¯
            document.getElementById('entryId').textContent = data.entry_id;
            document.getElementById('competitionType').textContent = data.competition_type;
            document.getElementById('createdAt').textContent = data.created_at ? new Date(data.created_at).toLocaleString('zh-CN') : '-';
            document.getElementById('extraText').textContent = data.extra_text || 'æ— ';
            document.getElementById('imageUrl').textContent = data.image_url;
            
            // æ¸²æŸ“å›¾ç‰‡é¢„è§ˆ
            if (data.image_url) {
                document.getElementById('imagePreview').innerHTML = `<img src="${data.image_url}" alt="ä½œå“å›¾ç‰‡">`;
            }
            
            // æ¸²æŸ“é˜¶æ®µä¸€ï¼šç‹¬ç«‹è¯„åˆ†
            renderStageOne(data.stage_one);
            
            // æ¸²æŸ“é˜¶æ®µäºŒï¼šç¾¤èŠè®¨è®º
            renderStageTwo(data.stage_two);
        }
        
        function renderStageOne(stageOne) {
            const container = document.getElementById('stageOneContent');
            
            if (!stageOne.judges || stageOne.judges.length === 0) {
                container.innerHTML = '<div class="no-data">æš‚æ— è¯„åˆ†æ•°æ®</div>';
                return;
            }
            
            let html = '';
            
            stageOne.judges.forEach((judge, index) => {
                html += `
                    <div class="judge-card">
                        <div class="judge-header">
                            <div>
                                <div class="judge-name">${judge.judge_display_name}</div>
                                <div style="color: #666; font-size: 14px; margin-top: 5px;">ID: ${judge.judge_id}</div>
                            </div>
                            <div>
                                ${judge.model_name ? `<div class="judge-model">ğŸ¤– ${judge.model_name}</div>` : ''}
                                <div class="score-badge">â­ ${judge.response.overall_score}</div>
                            </div>
                        </div>
                        
                        <button class="toggle-button" onclick="toggleContent('request-${index}')">
                            æŸ¥çœ‹è¯·æ±‚ä¸Šä¸‹æ–‡ â–¼
                        </button>
                        
                        <div id="request-${index}" class="collapsible-content">
                            <div class="context-box">
                                <div class="context-label">ğŸ“‹ System Message (ç³»ç»Ÿæ¶ˆæ¯)</div>
                                ${escapeHtml(judge.request_context.system_message || 'æ— ')}
                            </div>
                            
                            <div class="context-box">
                                <div class="context-label">ğŸ“¸ User Instruction (ç”¨æˆ·æŒ‡ä»¤)</div>
                                ${escapeHtml(judge.request_context.user_instruction || 'æ— ')}
                            </div>
                        </div>
                        
                        <button class="toggle-button" onclick="toggleContent('response-${index}')">
                            æŸ¥çœ‹å›å¤è¯¦æƒ… â–¼
                        </button>
                        
                        <div id="response-${index}" class="collapsible-content">
                            <div class="response-box">
                                <div class="response-label">ğŸ’¬ ä¸€å¥è¯ç‚¹è¯„</div>
                                ${judge.response.one_liner || '-'}
                            </div>
                            
                            <div class="response-box">
                                <div class="response-label">ğŸ“ è¯¦ç»†è¯„è¯­</div>
                                ${judge.response.comment_for_audience || '-'}
                            </div>
                            
                            ${judge.response.strengths && judge.response.strengths.length > 0 ? `
                                <div class="response-box">
                                    <div class="response-label">âœ… ä¼˜ç‚¹</div>
                                    <ul style="margin-left: 20px;">
                                        ${judge.response.strengths.map(s => `<li>${s}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${judge.response.weaknesses && judge.response.weaknesses.length > 0 ? `
                                <div class="response-box">
                                    <div class="response-label">âš ï¸ ç¼ºç‚¹</div>
                                    <ul style="margin-left: 20px;">
                                        ${judge.response.weaknesses.map(w => `<li>${w}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <div class="context-label" style="color: #333; margin-top: 15px;">
                                ğŸ”§ Raw Output (åŸå§‹è¾“å‡º)
                                <button class="copy-button" onclick="copyToClipboard(\`${escapeForJs(judge.response.raw_output)}\`)">å¤åˆ¶</button>
                            </div>
                            <div class="json-output">${escapeHtml(judge.response.raw_output || 'æ— ')}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function renderStageTwo(stageTwo) {
            const container = document.getElementById('stageTwoContent');
            
            if (!stageTwo.debate_sessions || stageTwo.debate_sessions.length === 0) {
                container.innerHTML = '<div class="no-data">æš‚æ— è®¨è®ºæ•°æ®</div>';
                return;
            }
            
            let html = '';
            
            stageTwo.debate_sessions.forEach((session, sessionIndex) => {
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">
                            è®¨è®ºä¼šè¯ ${sessionIndex + 1}
                            <span style="font-size: 14px; color: #999; font-weight: normal;">
                                (${session.participants.length} ä½å‚ä¸è€…)
                            </span>
                        </h3>
                        
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <strong>å‚ä¸è¯„å§”:</strong> ${session.participants.join(', ')}
                        </div>
                `;
                
                // å±•ç¤ºåˆå§‹æ¶ˆæ¯å’Œé€‰æ‹©å™¨æç¤ºè¯
                if (session.initial_message || session.selector_prompt) {
                    html += `
                        <button class="toggle-button" onclick="toggleContent('session-context-${sessionIndex}')">
                            æŸ¥çœ‹ç¾¤èŠä¸Šä¸‹æ–‡ â–¼
                        </button>
                        
                        <div id="session-context-${sessionIndex}" class="collapsible-content">
                    `;
                    
                    if (session.initial_message) {
                        html += `
                            <div class="context-box">
                                <div class="context-label">ğŸ“ Initial Message (åˆå§‹æ¶ˆæ¯)</div>
                                ${escapeHtml(session.initial_message)}
                            </div>
                        `;
                    }
                    
                    if (session.selector_prompt) {
                        html += `
                            <div class="context-box">
                                <div class="context-label">ğŸ¯ Selector Prompt (é€‰æ‹©å™¨æç¤ºè¯)</div>
                                ${escapeHtml(session.selector_prompt)}
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                }
                
                // å±•ç¤ºæ¯ä¸ªè¯„å§”çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
                if (session.judge_contexts) {
                    html += `
                        <button class="toggle-button" onclick="toggleContent('session-judges-${sessionIndex}')">
                            æŸ¥çœ‹è¯„å§”ä¸Šä¸‹æ–‡é…ç½® â–¼
                        </button>
                        
                        <div id="session-judges-${sessionIndex}" class="collapsible-content">
                    `;
                    
                    for (const [judgeId, context] of Object.entries(session.judge_contexts)) {
                        html += `
                            <div class="judge-card" style="margin-bottom: 15px;">
                                <div class="judge-header">
                                    <div class="judge-name">${context.display_name || judgeId}</div>
                                    ${context.model_name ? `<div class="judge-model">ğŸ¤– ${context.model_name}</div>` : ''}
                                </div>
                                
                                <div class="context-box">
                                    <div class="context-label">ğŸ“‹ System Message (ç³»ç»Ÿæ¶ˆæ¯)</div>
                                    ${escapeHtml(context.system_message || 'æ— ')}
                                </div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                }
                
                // å±•ç¤ºå¯¹è¯æ¶ˆæ¯
                html += '<h4 style="color: #333; margin: 20px 0 15px 0;">ğŸ’¬ å¯¹è¯è®°å½•</h4>';
                
                if (session.messages && session.messages.length > 0) {
                    session.messages.forEach((msg, msgIndex) => {
                        // ä» judge_contexts è·å–è¯„å§”æ˜¾ç¤ºåç§°
                        let speakerName = msg.speaker;
                        if (session.judge_contexts && session.judge_contexts[msg.speaker]) {
                            speakerName = session.judge_contexts[msg.speaker].display_name || msg.speaker;
                        }
                        
                        html += `
                            <div class="debate-message" style="position: relative;">
                                <div class="debate-speaker">
                                    <span class="debate-sequence">#${msg.sequence}</span>
                                    ${speakerName}
                                    ${msg.model_name ? `<span style="font-size: 12px; color: #999; margin-left: 10px;">ğŸ¤– ${msg.model_name}</span>` : ''}
                                </div>
                                <div class="debate-content">${escapeHtml(msg.content)}</div>
                                
                                ${msg.context_history || msg.raw_response ? `
                                    <button class="toggle-button" style="margin-top: 10px;" onclick="toggleContent('msg-debug-${sessionIndex}-${msgIndex}')">
                                        æŸ¥çœ‹è°ƒè¯•è¯¦æƒ… â–¼
                                    </button>
                                    
                                    <div id="msg-debug-${sessionIndex}-${msgIndex}" class="collapsible-content">
                                        ${msg.context_history ? `
                                            <div class="context-box">
                                                <div class="context-label">ğŸ“‹ Context History (å‘è¨€æ—¶çš„ä¸Šä¸‹æ–‡å†å²)</div>
                                                <div style="color: #999; font-size: 12px; margin-bottom: 10px;">
                                                    æ­¤è¯„å§”å‘è¨€æ—¶çœ‹åˆ°çš„æ‰€æœ‰å†å²æ¶ˆæ¯ï¼ˆå…± ${msg.context_history.length} æ¡ï¼‰
                                                </div>
                                                ${msg.context_history.map((ctx, ctxIdx) => `
                                                    <div style="background: ${ctx.source === 'user' ? '#fff3cd' : '#e3f2fd'}; padding: 8px; margin-bottom: 8px; border-radius: 4px; border-left: 3px solid ${ctx.source === 'user' ? '#ffc107' : '#2196f3'};">
                                                        <div style="font-weight: bold; font-size: 12px; color: #666; margin-bottom: 4px;">
                                                            ${ctxIdx + 1}. ${ctx.source === 'user' ? 'ğŸ”µ Initial Message' : 'ğŸ’¬ ' + ctx.source}
                                                        </div>
                                                        <div style="font-size: 13px; white-space: pre-wrap;">
                                                            ${escapeHtml(ctx.content.substring(0, 200))}${ctx.content.length > 200 ? '...' : ''}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                        
                                        ${msg.raw_response ? `
                                            <div class="context-box">
                                                <div class="context-label">
                                                    ğŸ”§ Raw Response (åŸå§‹å“åº”)
                                                    <button class="copy-button" onclick="copyToClipboard(\`${escapeForJs(msg.raw_response)}\`)">å¤åˆ¶</button>
                                                </div>
                                                ${escapeHtml(msg.raw_response)}
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                } else {
                    html += '<div class="no-data">æš‚æ— æ¶ˆæ¯</div>';
                }
                
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function toggleContent(id) {
            const element = document.getElementById(id);
            element.classList.toggle('active');
        }
        
        function switchTab(tab) {
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // åˆ‡æ¢å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tab}Tab`).classList.add('active');
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function escapeForJs(text) {
            if (!text) return '';
            return text.replace(/`/g, '\\`').replace(/\$/g, '\\$');
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }
    </script>
</body>
</html>

